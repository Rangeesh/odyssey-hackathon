{% extends "video_generator/base.html" %}

{% block content %}
<div class="search-section">
    <h2>Generate Music Video</h2>
    <p class="instruction">First, search for a song to preview the lyrics. Then generate your video.</p>
    
    <form method="get" action="{% url 'search_lyrics' %}">
        <div class="search-box-container">
            <div class="search-box">
                <input type="text" 
                       name="q" 
                       id="song-input" 
                       placeholder="Enter song name and artist (e.g., Bohemian Rhapsody Queen)"
                       value="{{ query|default:'' }}"
                       autocomplete="off"
                       required>
                <button type="submit" class="generate-btn">üîç Find Lyrics</button>
            </div>
            <div id="search-suggestions" class="suggestions-dropdown" style="display: none;"></div>
        </div>
    </form>

    {% if error_message %}
    <div class="error-message">
        <p>‚ùå {{ error_message }}</p>
    </div>
    {% endif %}

    {% if lyrics %}
    <div class="lyrics-preview">
        <h3>‚úì Lyrics Found!</h3>
        <div class="lyrics-text">{{ lyrics|linebreaks }}</div>
        
        <form method="post" action="{% url 'generate_video' %}">
            {% csrf_token %}
            <input type="hidden" name="song_title" value="{{ song_title }}">
            <input type="hidden" name="artist" value="{{ artist }}">
            <div class="generate-actions">
                <button type="submit" class="generate-btn">üé¨ Generate Video</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if not lyrics %}
    <div class="info-box">
        <h3>üí° How it works:</h3>
        <ol>
            <li>Search for a song to find its lyrics</li>
            <li>Review the lyrics to ensure they are correct</li>
            <li>Click "Generate Video" to start the AI process</li>
            <li>Watch as images are created for each scene</li>
            <li>Enjoy your final animated music video!</li>
        </ol>
        <p><strong>Note:</strong> Video generation can take 5-10 minutes depending on the song length.</p>
    </div>
    {% endif %}
</div>

<div class="jobs-section">
    <h2>Recent Video Jobs</h2>
    <div id="jobs-list">
        {% include "video_generator/job_list_partial.html" %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh jobs every 3 seconds
    let isVideoPlaying = false;
    
    // Store user-modified state of jobs
    // Map: jobId -> boolean (true = minimized, false = maximized)
    // Only stores state if user explicitly interacted with the card
    let userJobStates = new Map();

    // Add event listeners to track video playing state
    document.addEventListener('play', function(e) {
        if(e.target.tagName === 'VIDEO') {
            isVideoPlaying = true;
        }
    }, true);
    
    document.addEventListener('pause', function(e) {
        if(e.target.tagName === 'VIDEO') {
            isVideoPlaying = false;
        }
    }, true);
    
    document.addEventListener('ended', function(e) {
        if(e.target.tagName === 'VIDEO') {
            isVideoPlaying = false;
        }
    }, true);

    setInterval(function() {
        // Don't refresh if a video is playing
        if (isVideoPlaying) return;
        
        fetch('{% url "job_list_partial" %}')
            .then(response => response.text())
            .then(html => {
                const currentContainer = document.getElementById('jobs-list');
                
                // Simple equality check to prevent unnecessary DOM updates
                if (currentContainer.innerHTML.trim() === html.trim()) {
                    return;
                }
                
                // Create a temporary container to parse the new HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Apply minimized states BEFORE injecting into the DOM
                // This prevents the "flash" of expanded content causing layout shifts
                tempDiv.querySelectorAll('.job-card').forEach(card => {
                    const jobId = card.getAttribute('data-job-id');
                    if (jobId && userJobStates.has(jobId)) {
                        const shouldBeMinimized = userJobStates.get(jobId);
                        if (shouldBeMinimized) {
                            card.classList.add('minimized');
                        } else {
                            card.classList.remove('minimized');
                        }
                    }
                });
                
                // Now swap the content
                currentContainer.innerHTML = tempDiv.innerHTML;
            })
            .catch(error => console.error('Error refreshing jobs:', error));
    }, 3000);

    // Toggle job card minimize/maximize
    function toggleJobCard(card, event) {
        // Don't toggle if clicking on buttons or links
        if (event.target.closest('button') || event.target.closest('a') || event.target.closest('video')) {
            return;
        }
        
        // Toggle class
        card.classList.toggle('minimized');
        
        // Store user preference
        const jobId = card.getAttribute('data-job-id');
        const isMinimized = card.classList.contains('minimized');
        if (jobId) {
            userJobStates.set(jobId, isMinimized);
        }
    }

    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
